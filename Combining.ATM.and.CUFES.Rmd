---
title: "Combining CPS ATM and CalCOFI Surveys"
author: "Stephanie Hopkins"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: TRUE
    
---

```{r setup, include=FALSE}

knitr::opts_knit$set(root.dir = "C:/Users/shopkin1/Documents/")
rm(list=ls())
gc()

load.lib <- c("tidyverse", "data.table", "cowplot", "sf", "grid", "ggspatial",
              "ggnewscale", "RColorBrewer", "scales", "rcompanion", "rnaturalearth",
              "rnaturalearthhires", "r4ss", "patchwork", "rmapshaper", "zoo", "here")

install.lib <- load.lib[!load.lib %in% installed.packages()]

for(lib in install.lib) install.packages(lib,dependencies=TRUE)
sapply(load.lib,require,character=TRUE)

sf_use_s2(FALSE)

dir <- "C:/Users/shopkin1/Documents"

Figure.path <- "Figures/"

# Path to CPS ATM Survey Data
path.CPS.ATM <- here(getwd(), 'ATM.Survey', 'Shapefiles')

```

# Load all wrangled CalCOFI CUFES Survey data

For simplicity we load all OM spatial extents simultaneously. 

```{r, load.CUFES}

path.CUFES <- here(getwd(), 'CUFES.Survey', 'Shapefiles')

# Load all CUFES files
shp_files2 <- list.files(path.CUFES, 
                         pattern = "\\.shp$", 
                         full.names = FALSE)

for (file in shp_files2) {
  
  # 1. Strip off the .shp  
  base_name <- sub("\\.shp$", "", file)
  # 2. Normalize name → underscores for hyphens  
  obj_name <- gsub("[-\\]", "_", base_name)
  # 3. Append source to name
  obj_name <-paste(obj_name, "_CUFES",sep="")
  message("Reading ", file, " -> object ‘", obj_name, "’")
  # 4. Read the shapefile  
  sf_obj <- read_sf(file.path(path.CUFES, file))
  # 5. Add source_file column  
  sf_obj$source_file <- obj_name
  # 6. Assign into global environment  
  assign(obj_name, sf_obj, envir = .GlobalEnv)

  }

rm(shp_files2, sf_obj)

```

# Set min and max geographical extents

```{r, Create.common.breaks}

lat_breaks <- seq(27, 55, 4)  # Latitude breaks

lat_labels <- c(paste(27, "\u00b0", "N", sep=""),
                paste(31, "\u00b0", "N", sep=""),
                paste(35, "\u00b0", "N", sep=""),
                paste(39, "\u00b0", "N", sep=""),
                paste(43, "\u00b0", "N", sep=""),
                paste(47, "\u00b0", "N", sep=""),
                paste(51, "\u00b0", "N", sep=""),
                paste(55, "\u00b0", "N", sep=""))

#-----------------------------------------------------------------------------
# Make coastline backdrop
#-------------------------

PacificCoast <- ne_countries(scale = 10, returnclass = "sf")
PacificCoast2 <- st_crop(PacificCoast, xmin = -130, xmax = -110, ymin = 25, ymax = 55)
class(PacificCoast2)

#-----------------------------------------------------------------------------
# Plot output
#-------------------------

ggplot() +
    geom_sf(data = PacificCoast2, fill = "#D2B48C", col = "#927143") +
    xlab("Longitude") + ylab("Latitude") +
    ggtitle("West Coast map") +
    theme_classic()


```

# Apply min and max geographical extents

```{r, adjust.map.dimensions}

#-----------------------------------------------------------------------------
# Convert to sf object
#-----------------------------------------------------------------------------

PacificCoast3 <- PacificCoast2 %>%
  st_transform(., crs = 4326)

plot(PacificCoast3)

#-----------------------------------------------------------------------------
# Find spatial extents
#-----------------------------------------------------------------------------

xmin <- st_bbox(PacificCoast3)["xmin"]
xmin
# [1] -130

xmax <- st_bbox(PacificCoast3)["xmax"]
xmax
# [1] -110

#-----------------------------------------------------------------------------
# Crop land mass
#-----------------------------------------------------------------------------

PacificCoast4 <- PacificCoast3 %>% 
  # Clip the shapefile to match the latitude range
  st_crop(PacificCoast3, 
          xmin = -127, 
          xmax = -111,
          ymin = 27, 
          ymax = 55)
  
#-----------------------------------------------------------------------------
# Plot
#-----------------------------------------------------------------------------

PacificCoast4.map <-
  ggplot() +
  geom_sf(data = PacificCoast4,
          color = "#ae8f60", 
          size = 0.7, 
          fill = "#E1C699") +
  theme_void() +
  scale_y_continuous(limits = c(27,55), 
                     breaks = lat_breaks, 
                     labels = lat_labels, 
                     expand = c(0.05, 0.05)) +
  labs(y = "Latitude")

PacificCoast4.map

st_bbox(PacificCoast4)
#     xmin ymin xmax ymax
# [1] -127   27 -111   55

```

# Creat hline boundaries

Because the current model looks at only the Northern sub population in US waters, one of the boundary extents should include the national boarders.

The second should look at the coast of California where the most mixing is thought to occur for Pacific Sardine sub populations (under the current survey hypothesis)

```{r, find.original.model.break.dimensions}

#-----------------------------------------------------------------------------
# In order to find the state boundary extents, use ne_states function in
# rnaturalearth
#-----------------------------------------------------------------------------

# Find state boundaries
PCoastStates <- ne_states(returnclass = "sf") %>%
  st_intersection(PacificCoast4) 

#-----------------------------------------------------------------------------
# For EEZ definitions 
#-----------------------------------------------------------------------------

# https://nauticalcharts.noaa.gov/data/us-maritime-limits-and-boundaries.html

eez <- read_sf(paste(dir,"/CUFES.Survey/EEZ/USMaritimeLimitsNBoundaries.shp", 
                     sep = ""))

#-----------------------------------------------------------------------------
# Putting it all together
#-----------------------------------------------------------------------------

hlines <- eez %>%
  filter(REGION == "Pacific Coast") %>%
  mutate(
    # Create southern US EEZ boundary
    ymin = st_bbox(.)["ymin"],
    # Create northern US EEZ boundary
    ymax = st_bbox(.)["ymax"],
    # Create northern stock boundary (Westernmost Point, CA)
    nstock = 40.4385,
    # Create southern stock boundary (Point Conception, CA)
    point.concept = 34.4486)

```

# Add cities

To make the map easier to interpret, add the names and locations of most populated cites

```{r, add.map.details}

#-----------------------------------------------------------------------------
# populated areas (cities and city names)
#-----------------------------------------------------------------------------

Populated10 <- ne_download(scale = 110, type = "populated_places_simple", 
                           category = "cultural", 
                           returnclass = "sf") %>%
  st_intersection(PacificCoast4)

#-----------------------------------------------------------------------------
# Plot definitions
#-----------------------------------------------------------------------------

ggplot() +
  geom_hline(data = hlines, aes(yintercept = nstock), col = "blue", 
             linewidth = 0.7, linetype = "dashed") +
  geom_hline(data = hlines, aes(yintercept = point.concept), col = "red", 
             linewidth = 0.7, linetype = "longdash") +
  geom_hline(data = hlines, aes(yintercept = ymin), col = "black", 
             linewidth = 0.7) +
  geom_hline(data = hlines, aes(yintercept = ymax), col = "black", 
             linewidth = 0.7) +
  geom_sf(data = PacificCoast4,
          color = "#ae8f60", 
          size = 0.7, 
          fill = "#E1C699") +
  geom_sf(data = PCoastStates,
          color = "#ae8f60", 
          size = 0.7, 
          fill = "#E1C699") +
  geom_sf(data = Populated10, col = "black") +
  geom_text(data = Populated10,
            aes(x = longitude, y = latitude, label = name),
            col = "black", 
            position = position_dodge(width = 1),
            vjust = 1) +
  scale_y_continuous(limits = c(27,55), 
                     breaks = lat_breaks, 
                     labels = lat_labels, 
                     expand = c(0.05, 0.05)) +
  labs(y = "Latitude")

  
```

# Produce figures

For each OM spatial extent, make a LFD figure and a Figure combining the CPUE computations by length bin and CUFES data. The CUFES data will be the same across all length bins, but changes between OM spatial extent.

## Create plot scales

```{r, full.series.CPUE.range}

path.CPS.ATM <- here(getwd(), 'ATM.Survey', 'Shapefiles')

# Load all CPS.ATM files
shp_files.OMs <- list.files(path.CPS.ATM,
                            pattern = "\\.shp$", 
                            full.names = FALSE)


all.OMs <- lapply(paste0(path.CPS.ATM, "/", shp_files.OMs), read_sf)

# Bind rows (keeps each feature separate, preserves attributes)
combOMs.sf <- bind_rows(all.OMs)

pres.range <- combOMs.sf %>%
  filter(len_bin != 0)

lim.min <- min(pres.range$CPUE)
lim.max <- max(pres.range$CPUE)

range.absent <- combOMs.sf %>%
  filter(len_bin == 0) 

```

## Create custom colour pallet

```{r, seasonal.colours}

# Create custom colour pallet
season.colors <- c(Spring = "lightgreen", 
                   Summer = "#3b4832", 
                   Winter = "#D1E8F2")

pie(rep(1,15), col = season.colors)

group.colors <- c("Spring - 100" = "#000000", 
                  "Spring - 125" = "#004949",
                  "Spring - 150" = "#009292",
                  "Spring - 175" = "#ff6db6",
                  "Spring - 200" = "#ffb6db",
                  "Spring - 225" = "#490092",
                  "Spring - 250" = "#006ddb",
                  "Spring - 100" = "#b66dff",
                  "Summer - 125" = "#6db6ff",
                  "Summer - 150" = "#b6dbff",
                  "Summer - 175" = "#920000",
                  "Summer - 200" = "#924900",
                  "Summer - 225" = "#db6d00",
                  "Summer - 250" = "#ffff6d")

pie(rep(1,14), col = group.colors)

```

## Read the resulting OM shape files - Area 1

Note that there is a separate shape file for each length bin used. You should 

```{r, read.OM.1.data}

# List all CPS.ATM files
shp_files.OM.1 <- list.files(path.CPS.ATM,
                        pattern = "^OM\\.1.*\\.shp$",
                        full.names = TRUE)

# Load listed CPS.ATM files
all.OM.1 <- lapply(shp_files.OM.1, read_sf)

# Bind rows (keeps each feature separate, preserves attributes)
combOM1.sf <- bind_rows(all.OM.1)

# subset absence data
Absent.OM.1 <- combOM1.sf %>%
  filter(len_bin == 0) %>%
  mutate(grp = factor(paste(Season, " - ", len_bin, sep = "")),
         LON = unlist(map(.$geometry,1)), 
         LAT = unlist(map(.$geometry,2))) %>%
      st_drop_geometry()

# Create a new CPS ATM Survey file grouping length bin and season
Present.OM.1 <- combOM1.sf %>%
  filter(len_bin != 0) %>%
  mutate(grp = factor(paste(Season, " - ", len_bin, sep = "")),
         LON = unlist(map(.$geometry,1)), 
         LAT = unlist(map(.$geometry,2))) %>%
      st_drop_geometry()

# Create a new CUFES Survey file grouping only season
Present.OM.1_CUFES <- OM.1_CUFES %>%
  filter(CPUE != 0) %>% 
  mutate(grp = factor(Season),
         LON = unlist(map(.$geometry,1)), 
         LAT = unlist(map(.$geometry,2))) %>%
      st_drop_geometry()

Absent.OM.1_CUFES <- OM.1_CUFES %>%
  filter(CPUE == 0) %>% 
  mutate(grp = factor(Season),
         LON = unlist(map(.$geometry,1)), 
         LAT = unlist(map(.$geometry,2))) %>%
      st_drop_geometry()

```

## Create OM Spatial Area 1 Plot

```{r, integrated.plot}

# Create unified column for all types
Present.OM.1$notation_type <- Present.OM.1$grp
Present.OM.1_CUFES$notation_type <- as.character(Present.OM.1_CUFES$Season)
#Absent.OM.1$notation_type <- "Absence of Sardine in Trawl"
#Absent.OM.1_CUFES$notation_type <- "Absence of Sardine Eggs"

# Combine palettes
legend.levels <- c(names(group.colors),
                   #"Absence of Sardine Eggs",
                   #"Absence of Sardine in Trawl",
                   names(season.colors))

color.values <- c(group.colors,
                  #"Absence of Sardine Eggs" = "darkgrey",
                  #"Absence of Sardine in Trawl" = "darkgrey",
                  season.colors)

fill.values <- c(group.colors,
                 #"Absence of Sardine Eggs" = "beige",
                 #"Absence of Sardine in Trawl" = "grey",
                 season.colors)

shape.values <- c(
  setNames(rep(21, length(group.colors)), names(group.colors)),
  #"Absence of Sardine Eggs" = 23,
  #"Absence of Sardine in Trawl" = 21,
  setNames(rep(23, length(season.colors)), names(season.colors)))

# Plot
cpue.by.lat.OM.1 <-  
  ggplot() +
  
  # Add CalCOFI CUFES absence data
  #geom_point(data = Absent.OM.1_CUFES,
  #           aes(x = tim_stp, 
  #               y = LAT, 
  #               color = notation_type, 
  #               fill = notation_type, 
  #               shape = notation_type),
  #           size = 1) +
  
  # Add CPS ATM Survey absence data
  #geom_point(data = Absent.OM.1,
  #           aes(x = tim_stp, 
  #               y = LAT, 
  #               color = notation_type, 
  #               fill = notation_type, 
  #               shape = notation_type),
  #           size = 1.5) +
  
  # Summarize CPS ATM Survey presence data
  stat_summary(data = Present.OM.1,
               fun = median,
               geom = 'line',
               linewidth = 0.75,
               aes(x = tim_stp, 
                   y = LAT, 
                   group = grp, 
                   color = notation_type)) +
  
  # Add CPS ATM Survey presence data points
  geom_point(data = Present.OM.1,
             aes(x = tim_stp, 
                 y = LAT, 
                 color = notation_type, 
                 fill = notation_type, 
                 shape = notation_type),
             size = 1.5) +
  
  # Summarise CalCOFI CUFES presence data
  stat_summary(data = Present.OM.1_CUFES,
               fun = median,
               geom = 'line',
               linewidth = 0.75,
               aes(x = tim_stp, 
                   y = LAT, 
                   group = Season, 
                   color = notation_type),
               linetype = "dashed") +
  
  # Add CalCOFI CUFES presence data points
  geom_point(data = Present.OM.1_CUFES,
             aes(x = tim_stp, 
                 y = LAT, 
                 color = notation_type, 
                 fill = notation_type, 
                 shape = notation_type),
             size = 2) +
  
  scale_color_manual(name = "Notation Type", 
                     values = color.values, 
                     breaks = legend.levels) +
  
  scale_fill_manual(name = "Notation Type", 
                    values = fill.values, 
                    breaks = legend.levels) +
  
  scale_shape_manual(name = "Notation Type", 
                     values = shape.values, 
                     breaks = legend.levels) +
  
  labs(x = "Year", y = "Latitude") +
       theme_bw() +
       theme(axis.text.x = element_text(angle = 60, hjust=1))

cpue.by.lat.OM.1

```

## Read the resulting OM shape files - Area 2

Note that there is a separate shape file for each length bin used. You should 

```{r, read.OM.2.data}

# List all CPS.ATM files
shp_files.OM.2 <- list.files(path.CPS.ATM,
                        pattern = "^OM\\.2.*\\.shp$",
                        full.names = TRUE)

# Load listed CPS.ATM files
all.OM.2 <- lapply(shp_files.OM.2, read_sf)

# Bind rows (keeps each feature separate, preserves attributes)
combOM2.sf <- bind_rows(all.OM.2)

# subset absence data
Absent.OM.2 <- combOM2.sf %>%
  filter(len_bin == 0) %>%
  mutate(grp = factor(paste(Season, " - ", len_bin, sep = "")),
         LON = unlist(map(.$geometry,1)), 
         LAT = unlist(map(.$geometry,2))) %>%
      st_drop_geometry()

# Create a new CPS ATM Survey file grouping length bin and season
Present.OM.2 <- combOM2.sf %>%
  filter(len_bin != 0) %>%
  mutate(grp = factor(paste(Season, " - ", len_bin, sep = "")),
         LON = unlist(map(.$geometry,1)), 
         LAT = unlist(map(.$geometry,2))) %>%
      st_drop_geometry()

# Create a new CUFES Survey file grouping only season
Present.OM.2_CUFES <- OM.2_CUFES %>%
  filter(CPUE != 0) %>% 
  mutate(grp = factor(Season),
         LON = unlist(map(.$geometry,1)), 
         LAT = unlist(map(.$geometry,2))) %>%
      st_drop_geometry()

Absent.OM.2_CUFES <- OM.2_CUFES %>%
  filter(CPUE == 0) %>% 
  mutate(grp = factor(Season),
         LON = unlist(map(.$geometry,1)), 
         LAT = unlist(map(.$geometry,2))) %>%
      st_drop_geometry()

```

## Create OM Spatial Area 2 Plot

```{r, integrated.OM.2.plot}

# Create unified column for all types
Present.OM.2$notation_type <- Present.OM.2$grp
Present.OM.2_CUFES$notation_type <- as.character(Present.OM.2_CUFES$Season)

# Combine palettes
legend.levels <- c(names(group.colors),
                   names(season.colors))

color.values <- c(group.colors,
                  season.colors)

fill.values <- c(group.colors,
                 season.colors)

shape.values <- c(
  setNames(rep(21, length(group.colors)), names(group.colors)),
  setNames(rep(23, length(season.colors)), names(season.colors)))

# Plot
cpue.by.lat.OM.2 <-  
  ggplot() +
  
  # Summarize CPS ATM Survey presence data
  stat_summary(data = Present.OM.2,
               fun = median,
               geom = 'line',
               linewidth = 0.75,
               aes(x = tim_stp, 
                   y = LAT, 
                   group = grp, 
                   color = notation_type)) +
  
  # Summarize CalCOFI CUFES presence data
  stat_summary(data = Present.OM.2_CUFES,
               fun = median,
               geom = 'line',
               linewidth = 0.75,
               aes(x = tim_stp, 
                   y = LAT, 
                   group = Season, 
                   color = notation_type),
               linetype = "dashed") +
  
  # Add summarised CalCOFI CUFES presence data points
  stat_summary(data = Present.OM.2_CUFES,
               fun = median,
               geom = 'point',
               size = 2,
               aes(x = tim_stp, 
                   y = LAT, 
                   group = Season, 
                   color = notation_type)) +
  
  scale_color_manual(name = "Notation Type", 
                     values = color.values, 
                     breaks = legend.levels) +
  
  scale_fill_manual(name = "Notation Type", 
                    values = fill.values, 
                    breaks = legend.levels) +
  
  scale_shape_manual(name = "Notation Type", 
                     values = shape.values, 
                     breaks = legend.levels) +
  
  labs(x = "Year", y = "Latitude") +
       theme_bw() +
       theme(axis.text.x = element_text(angle = 60, hjust=1))

cpue.by.lat.OM.2

```

## Read the resulting OM shape files - Area 3

Note that there is a separate shape file for each length bin used. You should 

```{r, read.OM.3.data}

# List all CPS.ATM files
shp_files.OM.3 <- list.files(path.CPS.ATM,
                        pattern = "^OM\\.3.*\\.shp$",
                        full.names = TRUE)

# Load listed CPS.ATM files
all.OM.3 <- lapply(shp_files.OM.3, read_sf)

# Bind rows (keeps each feature separate, preserves attributes)
combOM3.sf <- bind_rows(all.OM.3)

# subset absence data
Absent.OM.3 <- combOM3.sf %>%
  filter(len_bin == 0) %>%
  mutate(grp = factor(paste(Season, " - ", len_bin, sep = "")),
         LON = unlist(map(.$geometry,1)), 
         LAT = unlist(map(.$geometry,2))) %>%
      st_drop_geometry()

# Create a new CPS ATM Survey file grouping length bin and season
Present.OM.3 <- combOM3.sf %>%
  filter(len_bin != 0) %>%
  mutate(grp = factor(paste(Season, " - ", len_bin, sep = "")),
         LON = unlist(map(.$geometry,1)), 
         LAT = unlist(map(.$geometry,2))) %>%
      st_drop_geometry()

# Create a new CUFES Survey file grouping only season
Present.OM.3_CUFES <- OM.3_CUFES %>%
  filter(CPUE != 0) %>% 
  mutate(grp = factor(Season),
         LON = unlist(map(.$geometry,1)), 
         LAT = unlist(map(.$geometry,2))) %>%
      st_drop_geometry()

Absent.OM.3_CUFES <- OM.3_CUFES %>%
  filter(CPUE == 0) %>% 
  mutate(grp = factor(Season),
         LON = unlist(map(.$geometry,1)), 
         LAT = unlist(map(.$geometry,2))) %>%
      st_drop_geometry()

```

## Create OM Spatial Area 3 Plot

```{r, integrated.OM.3.plot}

# Create unified column for all types
Present.OM.3$notation_type <- Present.OM.3$grp
Present.OM.3_CUFES$notation_type <- as.character(Present.OM.3_CUFES$Season)

# Combine palettes
legend.levels <- c(names(group.colors),
                   names(season.colors))

color.values <- c(group.colors,
                  season.colors)

fill.values <- c(group.colors,
                 season.colors)

shape.values <- c(
  setNames(rep(21, length(group.colors)), names(group.colors)),
  setNames(rep(23, length(season.colors)), names(season.colors)))

# Plot
cpue.by.lat.OM.3 <-  
  ggplot() +
  
  # Summarize CPS ATM Survey presence data
  stat_summary(data = Present.OM.3,
               fun = median,
               geom = 'line',
               linewidth = 0.75,
               aes(x = tim_stp, 
                   y = LAT, 
                   group = grp, 
                   color = notation_type)) +
  
  # Summarize CalCOFI CUFES presence data
  stat_summary(data = Present.OM.3_CUFES,
               fun = median,
               geom = 'line',
               linewidth = 0.75,
               aes(x = tim_stp, 
                   y = LAT, 
                   group = Season, 
                   color = notation_type),
               linetype = "dashed") +
  
  # Add summarised CalCOFI CUFES presence data points
  stat_summary(data = Present.OM.3_CUFES,
               fun = median,
               geom = 'point',
               size = 2,
               aes(x = tim_stp, 
                   y = LAT, 
                   group = Season, 
                   color = notation_type)) +
  
  scale_color_manual(name = "Notation Type", 
                     values = color.values, 
                     breaks = legend.levels) +
  
  scale_fill_manual(name = "Notation Type", 
                    values = fill.values, 
                    breaks = legend.levels) +
  
  scale_shape_manual(name = "Notation Type", 
                     values = shape.values, 
                     breaks = legend.levels) +
  
  labs(x = "Year", y = "Latitude") +
       theme_bw() +
       theme(axis.text.x = element_text(angle = 60, hjust=1))

cpue.by.lat.OM.3

```

## Read the resulting OM shape files - Area 4

Note that there is a separate shape file for each length bin used. You should 

```{r, read.OM.4.data}

# List all CPS.ATM files
shp_files.OM.4 <- list.files(path.CPS.ATM,
                        pattern = "^OM\\.4.*\\.shp$",
                        full.names = TRUE)

# Load listed CPS.ATM files
all.OM.4 <- lapply(shp_files.OM.4, read_sf)

# Bind rows (keeps each feature separate, preserves attributes)
combOM4.sf <- bind_rows(all.OM.4)

# subset absence data
Absent.OM.4 <- combOM4.sf %>%
  filter(len_bin == 0) %>%
  mutate(grp = factor(paste(Season, " - ", len_bin, sep = "")),
         LON = unlist(map(.$geometry,1)), 
         LAT = unlist(map(.$geometry,2))) %>%
      st_drop_geometry()

# Create a new CPS ATM Survey file grouping length bin and season
Present.OM.4 <- combOM4.sf %>%
  filter(len_bin != 0) %>%
  mutate(grp = factor(paste(Season, " - ", len_bin, sep = "")),
         LON = unlist(map(.$geometry,1)), 
         LAT = unlist(map(.$geometry,2))) %>%
      st_drop_geometry()

# Create a new CUFES Survey file grouping only season
Present.OM.4_CUFES <- OM.4_CUFES %>%
  filter(CPUE != 0) %>% 
  mutate(grp = factor(Season),
         LON = unlist(map(.$geometry,1)), 
         LAT = unlist(map(.$geometry,2))) %>%
      st_drop_geometry()

Absent.OM.4_CUFES <- OM.4_CUFES %>%
  filter(CPUE == 0) %>% 
  mutate(grp = factor(Season),
         LON = unlist(map(.$geometry,1)), 
         LAT = unlist(map(.$geometry,2))) %>%
      st_drop_geometry()

```

## Create OM Spatial Area 4 Plot

```{r, integrated.OM.4.plot}


# Create unified column for all types
Present.OM.4$notation_type <- Present.OM.4$grp
Present.OM.4_CUFES$notation_type <- as.character(Present.OM.4_CUFES$Season)

# Combine palettes
legend.levels <- c(names(group.colors),
                   names(season.colors))

color.values <- c(group.colors,
                  season.colors)

fill.values <- c(group.colors,
                 season.colors)

shape.values <- c(
  setNames(rep(21, length(group.colors)), names(group.colors)),
  setNames(rep(23, length(season.colors)), names(season.colors)))

# Plot
cpue.by.lat.OM.4 <-  
  ggplot() +
  
  # Summarize CPS ATM Survey presence data
  stat_summary(data = Present.OM.4,
               fun = median,
               geom = 'line',
               linewidth = 0.75,
               aes(x = tim_stp, 
                   y = LAT, 
                   group = grp, 
                   color = notation_type)) +
  
  # Summarize CalCOFI CUFES presence data
  stat_summary(data = Present.OM.4_CUFES,
               fun = median,
               geom = 'line',
               linewidth = 0.75,
               aes(x = tim_stp, 
                   y = LAT, 
                   group = Season, 
                   color = notation_type),
               linetype = "dashed") +
  
  # Add summarised CalCOFI CUFES presence data points
  stat_summary(data = Present.OM.4_CUFES,
               fun = median,
               geom = 'point',
               size = 2,
               aes(x = tim_stp, 
                   y = LAT, 
                   group = Season, 
                   color = notation_type)) +
  
  scale_color_manual(name = "Notation Type", 
                     values = color.values, 
                     breaks = legend.levels) +
  
  scale_fill_manual(name = "Notation Type", 
                    values = fill.values, 
                    breaks = legend.levels) +
  
  scale_shape_manual(name = "Notation Type", 
                     values = shape.values, 
                     breaks = legend.levels) +
  
  labs(x = "Year", y = "Latitude") +
       theme_bw() +
       theme(axis.text.x = element_text(angle = 60, hjust=1))

cpue.by.lat.OM.4

```

## Read the resulting OM shape files - Area 5

Note that there is a separate shape file for each length bin used. You should 

```{r, read.OM.5.data}

# List all CPS.ATM files
shp_files.OM.5 <- list.files(path.CPS.ATM,
                        pattern = "^OM\\.5.*\\.shp$",
                        full.names = TRUE)

# Load listed CPS.ATM files
all.OM.5 <- lapply(shp_files.OM.5, read_sf)

# Bind rows (keeps each feature separate, preserves attributes)
combOM5.sf <- bind_rows(all.OM.5)

# subset absence data
Absent.OM.5 <- combOM5.sf %>%
  filter(len_bin == 0) %>%
  mutate(grp = factor(paste(Season, " - ", len_bin, sep = "")),
         LON = unlist(map(.$geometry,1)), 
         LAT = unlist(map(.$geometry,2))) %>%
      st_drop_geometry()

# Create a new CPS ATM Survey file grouping length bin and season
Present.OM.5 <- combOM5.sf %>%
  filter(len_bin != 0) %>%
  mutate(grp = factor(paste(Season, " - ", len_bin, sep = "")),
         LON = unlist(map(.$geometry,1)), 
         LAT = unlist(map(.$geometry,2))) %>%
      st_drop_geometry()

# Create a new CUFES Survey file grouping only season
Present.OM.5_CUFES <- OM.5_CUFES %>%
  filter(CPUE != 0) %>% 
  mutate(grp = factor(Season),
         LON = unlist(map(.$geometry,1)), 
         LAT = unlist(map(.$geometry,2))) %>%
      st_drop_geometry()

Absent.OM.5_CUFES <- OM.5_CUFES %>%
  filter(CPUE == 0) %>% 
  mutate(grp = factor(Season),
         LON = unlist(map(.$geometry,1)), 
         LAT = unlist(map(.$geometry,2))) %>%
      st_drop_geometry()

```

## Create OM Spatial Area 5 Plot

```{r, integrated.OM.5.plot}

# Create unified column for all types
Present.OM.5$notation_type <- Present.OM.5$grp
Present.OM.5_CUFES$notation_type <- as.character(Present.OM.5_CUFES$Season)
#Absent.OM.5$notation_type <- "Absence of Sardine in Trawl"
#Absent.OM.5_CUFES$notation_type <- "Absence of Sardine Eggs"

# Combine palettes
legend.levels <- c(names(group.colors),
                   #"Absence of Sardine Eggs",
                   #"Absence of Sardine in Trawl",
                   names(season.colors))

color.values <- c(group.colors,
                  #"Absence of Sardine Eggs" = "darkgrey",
                  #"Absence of Sardine in Trawl" = "darkgrey",
                  season.colors)

fill.values <- c(group.colors,
                 #"Absence of Sardine Eggs" = "beige",
                 #"Absence of Sardine in Trawl" = "grey",
                 season.colors)

shape.values <- c(
  setNames(rep(21, length(group.colors)), names(group.colors)),
  #"Absence of Sardine Eggs" = 23,
  #"Absence of Sardine in Trawl" = 21,
  setNames(rep(23, length(season.colors)), names(season.colors)))

# Plot
cpue.by.lat.OM.5 <-  
  ggplot() +
  
  # Add CalCOFI CUFES absence data
  #geom_point(data = Absent.OM.5_CUFES,
  #           aes(x = tim_stp, 
  #               y = LAT, 
  #               color = notation_type, 
  #               fill = notation_type, 
  #               shape = notation_type),
  #           size = 1) +
  
  # Add CPS ATM Survey absence data
  #geom_point(data = Absent.OM.5,
  #           aes(x = tim_stp, 
  #               y = LAT, 
  #               color = notation_type, 
  #               fill = notation_type, 
  #               shape = notation_type),
  #           size = 1.5) +
  
  # Summarize CPS ATM Survey presence data
  stat_summary(data = Present.OM.5,
               fun = median,
               geom = 'line',
               linewidth = 0.75,
               aes(x = tim_stp, 
                   y = LAT, 
                   group = grp, 
                   color = notation_type)) +
  
  # Add CPS ATM Survey presence data points
  geom_point(data = Present.OM.5,
             aes(x = tim_stp, 
                 y = LAT, 
                 color = notation_type, 
                 fill = notation_type, 
                 shape = notation_type),
             size = 1.5) +
  
  # Summarise CalCOFI CUFES presence data
  stat_summary(data = Present.OM.5_CUFES,
               fun = median,
               geom = 'line',
               linewidth = 0.75,
               aes(x = tim_stp, 
                   y = LAT, 
                   group = Season, 
                   color = notation_type),
               linetype = "dashed") +
  
  # Add CalCOFI CUFES presence data points
  geom_point(data = Present.OM.5_CUFES,
             aes(x = tim_stp, 
                 y = LAT, 
                 color = notation_type, 
                 fill = notation_type, 
                 shape = notation_type),
             size = 2) +
  
  scale_color_manual(name = "Notation Type", 
                     values = color.values, 
                     breaks = legend.levels) +
  
  scale_fill_manual(name = "Notation Type", 
                    values = fill.values, 
                    breaks = legend.levels) +
  
  scale_shape_manual(name = "Notation Type", 
                     values = shape.values, 
                     breaks = legend.levels) +
  
  labs(x = "Year", y = "Latitude") +
       theme_bw() +
       theme(axis.text.x = element_text(angle = 60, hjust=1))

cpue.by.lat.OM.5

```

```{r, spatial.areas.combined}

# Plot
cpue.by.lat.OMs <-  
  ggplot() +
  
  #------------------------------------------------------------------
  # OM Spatial Area 1
  #------------------------------------------------------------------
  
  # Summarize CPS ATM Survey presence data
  stat_summary(data = Present.OM.1,
               fun = median,
               geom = 'line',
               linewidth = 0.75,
               aes(x = tim_stp, 
                   y = LAT, 
                   group = grp, 
                   color = notation_type)) +
  
  # Add CPS ATM Survey presence data points
  stat_summary(data = Present.OM.1,
               fun = median,
               geom = 'point',
               size = 1.5,
               aes(x = tim_stp, 
                   y = LAT, 
                   group = grp, 
                   color = notation_type,
                   shape = notation_type)) +
  
  # Summarize CalCOFI CUFES presence data
  stat_summary(data = Present.OM.1_CUFES,
               fun = median,
               geom = 'line',
               linewidth = 0.75,
               aes(x = tim_stp, 
                   y = LAT, 
                   group = Season, 
                   color = notation_type),
               linetype = "dashed") +
  
  # Add summarized CalCOFI CUFES presence data points
  stat_summary(data = Present.OM.1_CUFES,
               fun = median,
               geom = 'point',
               size = 2,
               aes(x = tim_stp, 
                   y = LAT, 
                   group = Season, 
                   color = notation_type,
                   shape = notation_type))
  
  #------------------------------------------------------------------
  # OM Spatial Area 2
  #------------------------------------------------------------------

  # Summarize CPS ATM Survey presence data
  stat_summary(data = Present.OM.2,
               fun = median,
               geom = 'line',
               linewidth = 0.75,
               aes(x = tim_stp, 
                   y = LAT, 
                   group = grp, 
                   color = notation_type)) +
  
  # Add summarized CPS ATM Survey presence data points
  stat_summary(data = Present.OM.2,
               fun = median,
               geom = 'point',
               size = 1.5,
               aes(x = tim_stp, 
                   y = LAT, 
                   group = grp, 
                   color = notation_type,
                   shape = notation_type)) +
  
  # Summarize CalCOFI CUFES presence data
  stat_summary(data = Present.OM.2_CUFES,
               fun = median,
               geom = 'line',
               linetype = "dashed",
               linewidth = 0.75,
               aes(x = tim_stp, 
                   y = LAT, 
                   group = Season, 
                   color = notation_type)) +
  
  # Add summarized CalCOFI CUFES presence data points
  stat_summary(data = Present.OM.2_CUFES,
               fun = median,
               geom = 'point',
               size = 2,
               aes(x = tim_stp, 
                   y = LAT, 
                   group = Season, 
                   color = notation_type,
                   shape = notation_type)) +
  
  #------------------------------------------------------------------
  # OM Spatial Area 3
  #------------------------------------------------------------------
  
  # Summarize CPS ATM Survey presence data
  stat_summary(data = Present.OM.3,
               fun = median,
               geom = 'line',
               linewidth = 0.75,
               aes(x = tim_stp, 
                   y = LAT, 
                   group = grp, 
                   color = notation_type)) +
  
  # Add CPS ATM Survey presence data points 
  stat_summary(data = Present.OM.3,
               fun = median,
               geom = 'point',
               size = 1.5,
               aes(x = tim_stp, 
                   y = LAT, 
                   group = grp, 
                   color = notation_type,
                   shape = notation_type)) +
  
  # Summarize CalCOFI CUFES presence data
  stat_summary(data = Present.OM.3_CUFES,
               fun = median,
               geom = 'line',
               linewidth = 0.75,
               aes(x = tim_stp, 
                   y = LAT, 
                   group = Season, 
                   color = notation_type),
               linetype = "dashed") +
  
  # Add summarized CalCOFI CUFES presence data points
  stat_summary(data = Present.OM.3_CUFES,
               fun = median,
               geom = 'point',
               size = 2,
               aes(x = tim_stp, 
                   y = LAT, 
                   group = Season, 
                   color = notation_type,
                   shape = notation_type)) +
  
  #------------------------------------------------------------------
  # OM Spatial Area 4
  #------------------------------------------------------------------

  # Summarize CPS ATM Survey presence data
  stat_summary(data = Present.OM.4,
               fun = median,
               geom = 'line',
               linewidth = 0.75,
               aes(x = tim_stp, 
                   y = LAT, 
                   group = grp, 
                   color = notation_type)) +
  
  # Add CPS ATM Survey presence data points
  stat_summary(data = Present.OM.4,
               fun = median,
               geom = 'point',
               size = 1.5,
               aes(x = tim_stp, 
                   y = LAT, 
                   group = grp, 
                   color = notation_type,
                   shape = notation_type)) +
  
  # Summarize CalCOFI CUFES presence data
  stat_summary(data = Present.OM.4_CUFES,
               fun = median,
               geom = 'line',
               linewidth = 0.75,
               aes(x = tim_stp, 
                   y = LAT, 
                   group = Season, 
                   color = notation_type),
               linetype = "dashed") +
  
  # Add summarized CalCOFI CUFES presence data points
  stat_summary(data = Present.OM.4_CUFES,
               fun = median,
               geom = 'point',
               size = 2,
               aes(x = tim_stp, 
                   y = LAT, 
                   group = Season, 
                   color = notation_type,
                   shape = notation_type)) + 
  
  #------------------------------------------------------------------
  # OM Spatial Area 5
  #------------------------------------------------------------------

  # Summarize CPS ATM Survey presence data
  stat_summary(data = Present.OM.5,
               fun = median,
               geom = 'line',
               linewidth = 0.75,
               aes(x = tim_stp, 
                   y = LAT, 
                   group = grp, 
                   color = notation_type)) +
  
  # Add CPS ATM Survey presence data points
  stat_summary(data = Present.OM.5,
               fun = median,
               geom = 'point',
               size = 1.5,
               aes(x = tim_stp, 
                   y = LAT, 
                   group = grp, 
                   color = notation_type,
                   shape = notation_type)) +
  
  # Summarize CalCOFI CUFES presence data
  stat_summary(data = Present.OM.5_CUFES,
               fun = median,
               geom = 'line',
               linewidth = 0.75,
               aes(x = tim_stp, 
                   y = LAT, 
                   group = Season, 
                   color = notation_type),
               linetype = "dashed") +
  
  # Add summarized CalCOFI CUFES presence data points
  geom_point(data = Present.OM.5_CUFES,
             fun = median,
               geom = 'point',
               size = 2,
               aes(x = tim_stp, 
                   y = LAT, 
                   group = Season, 
                   color = notation_type,
                   shape = notation_type)) + 
  
  scale_color_manual(name = "Notation Type", 
                     values = color.values, 
                     breaks = legend.levels) +
  
  scale_fill_manual(name = "Notation Type", 
                    values = fill.values, 
                    breaks = legend.levels) +
  
  scale_shape_manual(name = "Notation Type", 
                     values = shape.values, 
                     breaks = legend.levels) + 
  
  geom_hline(data = hlines, aes(yintercept = nstock), col = "blue", 
             linewidth = 0.7, linetype = "dashed") +
  
  geom_hline(data = hlines, aes(yintercept = point.concept), col = "red", 
             linewidth = 0.7, linetype = "longdash") +
  
  geom_hline(data = hlines, aes(yintercept = ymin), col = "black", 
             linewidth = 0.7) +
  
  geom_hline(data = hlines, aes(yintercept = ymax), col = "black", 
             linewidth = 0.7) +
  
  scale_y_continuous(limits = c(27,55), 
                     breaks = lat_breaks, 
                     labels = lat_labels, 
                     expand = c(0.05, 0.05)) +
  
  labs(x = "Year", y = "Latitude") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust=1))

cpue.by.lat.OMs

```


```{r, integrated.plot}

PacificCoast4.map <-
  
  ggplot() +
  geom_hline(data = hlines, aes(yintercept = nstock), col = "blue", 
             linewidth = 0.7, linetype = "dashed") +
  geom_hline(data = hlines, aes(yintercept = point.concept), col = "red", 
             linewidth = 0.7, linetype = "longdash") +
  geom_hline(data = hlines, aes(yintercept = ymin), col = "black", 
             linewidth = 0.7) +
  geom_hline(data = hlines, aes(yintercept = ymax), col = "black", 
             linewidth = 0.7) +
  scale_y_continuous(limits = c(27,55), 
                     breaks = lat_breaks, 
                     labels = lat_labels, 
                     expand = c(0.05, 0.05)) +
  geom_sf(data = PacificCoast4,
          color = "#ae8f60", 
          size = 0.7, 
          fill = "#E1C699") +
  geom_sf(data = PCoastStates,
               color = "#ae8f60", 
               size = 0.7, 
               fill = "#E1C699") +
  geom_sf(data = Populated10, col = "black") +
  geom_text(data = Populated10,
            aes(x = longitude, y = latitude, label = name),
            col = "black", 
            position = position_dodge(width = 1),
            vjust = 1) +
  labs(y = "Latitude")

returned.plot <-
  # Combine the plots, ensuring they share the y-axis
  cpue.by.lat + 
  PacificCoast4.map + 
  plot_layout(guides = "collect") & theme(legend.position = "right")
  
returned.plot

```