---
title: "BuildSdmTMB.adapted.from.Barb"
author: "Stephanie Hopkins"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: TRUE
    
---

```{r setup, include=FALSE}

rm(list=ls())
gc()

load.lib <- c("tidyverse", "data.table", "cowplot", "sf", "visreg", 
              "geodata", # To get coastlines 
              "pROC", "here", "sdmTMB","sdmTMBextra", # for adding barrier mesh
              "ggforce" # enables plot_anisotropy
              )

install.lib <- load.lib[!load.lib %in% installed.packages()]

for(lib in install.lib) install.packages(lib,dependencies=TRUE)
sapply(load.lib,require,character=TRUE)

sf_use_s2(FALSE)

# remotes::install_github("pbs-assess/sdmTMBextra", dependencies = TRUE)

dir <- here(getwd())

```

# Load previous sdm data

Build new adult sardine SDM using environmental predictors from the 3km WC15 ROMS.
Vars are SST, surface chl-a, upper 50m zooplankton biomass, SSB. 
Chl-a didn't improve AUC, dropped for now.

```{r, load.previous.dat}

# Where previous data is stored
sdmDir <- here(dir, "Data", "Previous.sdmTMB.Data")

# Load data
dat <- readRDS(paste(sdmDir, "/sardineTrainingData.rds", sep = ""))

# Project data
dat2 <- dat %>%
  filter(yr > 2002 & survey == 'cps') %>% 
  distinct() %>%
  group_by(yr) %>%
  mutate(hauls = n_distinct(haul)) %>%
  ungroup() %>% 
  select(yr,cruise, haul, lat, hauls) %>% 
  distinct()
  View(dat2)

test2003 <- dat %>% filter(yr == 2003 & survey == 'cps')

length(unique(test2003$haul))
# [1] 41
# View(test2003)

```

# Load new sdm data

There will likely be some hauls not previously accounted, but the number of hauls should be similar. Use 2003 as a test run.

```{r, load.new.dat}

bufferTrans.dir <- here(getwd(), "Data", "Shapefiles")

areaTranBuff.polygons <- read_sf(file.path(paste(bufferTrans.dir, "/cluster.with.area.defs.shp", sep="")))
#View(areaTranBuff.polygons)

areaTranBuff.polygons.2003 <- areaTranBuff.polygons %>%
  filter(Year == 2003)
  
unique(areaTranBuff.polygons.2003$eqlbrm_) 

```

This resulted in 5 additional hauls than what was previously accounted for.

# Check differences in observations

```{r, load.summary.stat}

ClstSum <- fread(paste(dir,"/Results/summaryTable.csv", sep=""), sep=";")
View(ClstSum)

```

```{r, load.dropped.errors}

MissEnt <- fread(paste(dir,"/Data/Survey.Data/",
                       "ATM.Survey.missing.entry.error.csv",
                       sep=""), sep=",")%>%
  mutate(dropReas = "MissEnt",
         cruise = as.character(cruise),
         haul = as.character(haul))

unsolErr <- fread(paste(dir,"/Data/Survey.Data/",
                        "ATM.unsolved.error.csv",
                        sep=""), sep=",") %>%
  mutate(dropReas = "unsolErr",
         cruise = as.character(cruise),
         haul = as.character(haul))

MagErr <- fread(paste(dir,"/Data/Survey.Data/",
                      "ATM.Survey.magnitude.observation.error.csv", 
                      sep=""), sep=",") %>%
  mutate(dropReas = "MagErr",
         cruise = as.character(cruise),
         haul = as.character(haul))

XraSamp <- fread(paste(dir,"/Data/Survey.Data/",
                       "ATM.Survey.extra.sample.observation.errors.csv", 
                       sep=""), sep=",") %>%
  mutate(dropReas = "XraSamp",
         cruise = as.character(cruise),
         haul = as.character(haul))

```

## See why the observations are different

```{r, check.reasoning.for.diff}

data2.diff <- dat %>%
  filter(
      survey == 'cps' & haul %in% MissEnt$haul & cruise %in% MissEnt$cruise |
      survey == 'cps' & haul %in% unsolErr$haul & cruise %in% unsolErr$cruise |
      survey == 'cps' & haul %in% MagErr$haul & cruise %in% MagErr$cruise |
      survey == 'cps' & haul %in% XraSamp$haul & cruise %in% XraSamp$cruise) 

dim(data2.diff)
# [1] 655  31
length(unique(data2.diff$haul))
# [1] 54

# Note that the weight observations were redistributed
# based on the proportion of observations present in the haul
data2DiffRation <- inner_join(data2.diff, MissEnt)
dim(data2DiffRation)
# [1] 47 65
length(unique(data2DiffRation$haul))
# [1] 1

# Note that these hauls were dropped entirely
data2DiffRation1 <- inner_join(data2.diff, unsolErr)
dim(data2DiffRation1)
# [1] 793  66
length(unique(data2DiffRation1$haul))
# [1] 16

# Note that these were corrected for
data2DiffRation2 <- inner_join(data2.diff, MagErr)
dim(data2DiffRation2)
# [1] 50 64
length(unique(data2DiffRation2$haul))
# [1] 1

# Note that these observations observations were dropped, 
# but the remaining observations in the hauls kept
data2DiffRation3 <- inner_join(data2.diff, XraSamp)
dim(data2DiffRation3)
# [1] 789  64
length(unique(data2DiffRation3$haul))
# [1] 40

```

